{"version":3,"file":"Requests.js","sourceRoot":"/","sources":["Requests.ts"],"names":[],"mappings":"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","sourcesContent":["import axios, { AxiosInstance, AxiosRequestConfig, AxiosResponse } from \"axios\";\nimport { JobQueue } from \"jobqu\";\nimport rateLimit, { RateLimitedAxiosInstance, rateLimitOptions } from \"axios-rate-limit\";\nimport { Time } from \"@inventivetalent/time\";\nimport { RequestConfig, RequestKey } from \"./RequestConfig\";\n\n\nexport const GENERIC = \"generic\";\n\nconst MAX_QUEUE_SIZE = 100;\nconst TIMEOUT = 10000;\n\naxios.defaults.headers[\"User-Agent\"] = \"MineSkin\";\naxios.defaults.headers[\"Content-Type\"] = \"application/json\";\naxios.defaults.headers[\"Accept\"] = \"application/json\";\naxios.defaults.timeout = TIMEOUT;\n\nexport class Requests {\n\n    static readonly axiosInstance: AxiosInstance = axios.create({});\n\n    protected static readonly defaultRateLimit: rateLimitOptions = {\n        maxRequests: 600,\n        perMilliseconds: 10 * 60 * 1000\n    }\n\n    private static instances: Map<string, AxiosInstance> = new Map<string, AxiosInstance>();\n    private static queues: Map<string, JobQueue<AxiosRequestConfig, AxiosResponse>> = new Map<string, JobQueue<AxiosRequestConfig, AxiosResponse>>();\n\n    static init() {\n        this.setupInstance(GENERIC, {});\n        this.setupQueue(GENERIC, Time.millis(100), 1);\n    }\n\n    static registerInstance<K extends RequestKey>(config: RequestConfig<K>) {\n        const key = this.mapKey(config.key);\n        if (this.instances.has(key)) {\n            console.warn(`Instance with key ${ key } already exists!`);\n            return;\n        }\n        if (this.queues.has(key)) {\n            console.warn(`Queue with key ${ key } already exists!`);\n            return;\n        }\n\n        if (config.rateLimit) {\n            this.setupInstance(key, config.request, c => rateLimit(axios.create(c), config.rateLimit));\n        } else {\n            this.setupInstance(key, config.request);\n        }\n\n        if (config.queue) {\n            this.setupQueue(key, config.queue.interval, config.queue.maxPerRun);\n        }\n    }\n\n    private static mapKey(key: RequestKey): string {\n        if (typeof key === \"string\") {\n            return key;\n        }\n        return JSON.stringify(key);\n    }\n\n    protected static setupInstance(key: string, config: AxiosRequestConfig, constr: AxiosConstructor = (c) => axios.create(c)) {\n        this.instances.set(key, axios.create(config));\n        console.log(\"set up axios instance \" + key);\n    }\n\n    private static setupQueue(key: string, interval: number, maxPerRun: number): void {\n        this.queues.set(key, new JobQueue<AxiosRequestConfig, AxiosResponse>(request => {\n            return this.runAxiosRequest(request, key);\n        }, interval, maxPerRun));\n        console.log(\"set up request queue \" + key);\n    }\n\n    protected static async runAxiosRequest(request: AxiosRequestConfig, inst: AxiosInstance | string = this.axiosInstance): Promise<AxiosResponse> {\n        let instance: AxiosInstance;\n        if (typeof inst === \"string\") {\n            instance = this.instances.get(inst);\n        } else {\n            instance = inst as AxiosInstance;\n        }\n\n        if (!instance) {\n            throw new Error(\"No instance found for key \" + inst);\n        }\n\n        console.log(`=> ${ request.method } ${ request.url }`)\n\n        return instance.request(request);\n    }\n\n    public static async dynamicRequest<K extends RequestKey>(key: K, request: AxiosRequestConfig): Promise<AxiosResponse> {\n        const k = this.mapKey(key);\n        const q = this.queues.get(k);\n        if (!q) {\n            throw new Error(\"No queue found for key \" + k);\n        }\n\n        if (q.size > MAX_QUEUE_SIZE) {\n            console.warn(`Rejecting new request as queue for ${ k } is full (${ q.size })! `);\n            throw new Error(\"Request queue is full!\");\n        }\n        return await q.add(request);\n    }\n\n}\n\ntype AxiosConstructor = (config: AxiosRequestConfig) => AxiosInstance;\n"]}