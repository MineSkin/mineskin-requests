{"version":3,"file":"RequestManager.js","sourceRoot":"/","sources":["RequestManager.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,kDAAqG;AACrG,iCAAiC;AACjC,wEAA+D;AAC/D,gDAA6C;AAE7C,2BAAuC;AACvC,kDAAoC;AACpC,yDAAoD;AAEpD,iCAAkD;AAClD,qDAAuC;AAEvC,yCAA+C;AAC/C,yCAAwG;AAG3F,QAAA,OAAO,GAAG,SAAS,CAAC;AAEjC,MAAM,cAAc,GAAG,GAAG,CAAC;AAC3B,MAAM,OAAO,GAAG,KAAK,CAAC;AAGf,IAAM,cAAc,sBAApB,MAAM,cAAc;IAkBvB,iBAAiB;IACjB,MAAM,KAAK,QAAQ;QACf,IAAI,CAAC,IAAI,CAAC,SAAS,EAAE,CAAC;YAClB,OAAO,CAAC,KAAK,CAAC,sCAAsC,CAAC,CAAC;YACtD,IAAI,CAAC,SAAS,GAAG,IAAI,gBAAc,CAAC,SAAS,EAAE,SAAS,CAAC,CAAC;QAC9D,CAAC;QACD,OAAO,IAAI,CAAC,SAAS,CAAC;IAC1B,CAAC;IAED,iBAAiB;IACjB,MAAM,CAAC,IAAI;QACP,gBAAc,CAAC,QAAQ,CAAC;IAC5B,CAAC;IAED,iBAAiB;IACjB,MAAM,KAAK,aAAa;QACpB,OAAO,gBAAc,CAAC,QAAQ,CAAC,eAAe,CAAC;IACnD,CAAC;IAED,YACmC,WAA8C,EAC1C,OAA8C;QADzC,gBAAW,GAAX,WAAW,CAA0B;QACjC,YAAO,GAAP,OAAO,CAA8B;QAnC5E,oBAAe,GAAkB,IAAI,CAAC,mBAAmB,CAAC,EAAE,CAAC,CAAC;QAOpD,cAAS,GAA+B,IAAI,GAAG,EAAyB,CAAC;QACzE,WAAM,GAA6D,IAAI,GAAG,EAAuD,CAAC;QA6BjJ,IAAI,CAAC,WAAW,EAAE,CAAC;YACf,OAAO,CAAC,IAAI,CAAC,2BAA2B,CAAC,CAAC;QAC9C,CAAC;aAAM,CAAC;YACJ,IAAI,CAAC,MAAM,GAAG,WAAW,CAAC,CAAC,CAAC,KAAK,CAAC,EAAC,KAAK,EAAE,UAAU,EAAC,CAAC,CAAC;QAC3D,CAAC;QACD,IAAI,CAAC,OAAO,EAAE,CAAC;YACX,OAAO,CAAC,IAAI,CAAC,+BAA+B,CAAC,CAAC;QAClD,CAAC;QAED,MAAM,UAAU,GAAG,IAAA,sBAAiB,GAAE,CAAC;QACvC,CAAC,EAAE,KAAK,IAAI,EAAE,IAAI,UAAU,EAAE,CAAC;YAC3B,MAAM,KAAK,GAAG,UAAU,CAAC,EAAE,CAAC,CAAC;YAC7B,CAAC,EAAE,KAAK,IAAI,OAAO,IAAI,KAAK,EAAE,CAAC;gBAC3B,IAAI,CAAC,IAAA,+BAAwB,EAAC,OAAO,CAAC,EAAE,CAAC;oBACrC,SAAS,CAAC,CAAC,CAAC,iBAAiB;gBACjC,CAAC;gBAED,CAAC,IAAI,CAAC,MAAM,IAAI,OAAO,CAAC,CAAC,IAAI,CAAC,GAAI,OAAO,CAAC,MAAO,IAAK,OAAO,CAAC,OAAQ,IAAK,OAAO,CAAC,OAAQ,IAAK,OAAO,CAAC,GAAI,IAAK,OAAO,CAAC,IAAK,EAAE,CAAC,CAAC;gBAClI,gBAAc,CAAC,GAAG,CAAC,GAAG,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC;YAC5C,CAAC;QACL,CAAC;QAED,IAAI,CAAC,aAAa,CAAC,eAAO,EAAE,EAAE,CAAC,CAAC;QAChC,IAAI,CAAC,UAAU,CAAC,eAAO,EAAE,WAAI,CAAC,MAAM,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC,CAAC;IAClD,CAAC;IAED,iBAAiB;IACjB,MAAM,CAAC,gBAAgB,CAAuB,MAAwB;QAClE,OAAO,gBAAc,CAAC,QAAQ,CAAC,gBAAgB,CAAC,MAAM,CAAC,CAAC;IAC5D,CAAC;IAED,gBAAgB,CAAuB,MAAwB;;QAC3D,MAAM,GAAG,GAAG,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;QACpC,IAAI,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,GAAG,CAAC,EAAE,CAAC;YAC1B,CAAC,IAAI,CAAC,MAAM,IAAI,OAAO,CAAC,CAAC,IAAI,CAAC,qBAAsB,GAAI,kBAAkB,CAAC,CAAC;YAC5E,OAAO;QACX,CAAC;QACD,IAAI,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,GAAG,CAAC,EAAE,CAAC;YACvB,CAAC,IAAI,CAAC,MAAM,IAAI,OAAO,CAAC,CAAC,IAAI,CAAC,kBAAmB,GAAI,kBAAkB,CAAC,CAAC;YACzE,OAAO;QACX,CAAC;QAED,IAAI,MAAA,MAAM,aAAN,MAAM,uBAAN,MAAM,CAAE,EAAE,0CAAE,IAAI,EAAE,CAAC;YACnB,MAAM,IAAI,GAAG,MAAM,CAAC,EAAE,CAAC,IAAI,CAAC;YAC5B,IAAI,CAAC,gBAAc,CAAC,GAAG,CAAC,GAAG,CAAC,IAAI,CAAC,EAAE,CAAC;gBAChC,OAAO,CAAC,IAAI,CAAC,MAAO,IAAK,4BAA4B,CAAC,CAAC;YAC3D,CAAC;iBAAM,CAAC;gBACJ,OAAO,CAAC,IAAI,CAAC,WAAY,GAAI,UAAW,IAAK,EAAE,CAAC,CAAC;gBACjD,MAAM,CAAC,OAAO,CAAC,UAAU,GAAG,IAAI,KAAK,CAAC,KAAK,CAAC;oBACxC,YAAY,EAAE,MAAM,CAAC,EAAE,CAAC,IAAI;oBAC5B,MAAM,EAAE,MAAM,CAAC,EAAE,CAAC,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;iBAC/C,CAAC,CAAC;YACP,CAAC;QACL,CAAC;QAED,IAAI,MAAM,CAAC,KAAK,EAAE,CAAC;YACf,CAAC,IAAI,CAAC,MAAM,IAAI,OAAO,CAAC,CAAC,IAAI,CAAC,wBAAyB,GAAI,QAAS,MAAM,CAAC,KAAK,CAAC,IAAK,EAAE,CAAC,CAAC;YAC1F,MAAM,CAAC,OAAO,CAAC,UAAU,GAAG,IAAI,mCAAe,CAAC,MAAM,CAAC,KAAK,CAAC,CAAA;QACjE,CAAC;QAED,IAAI,MAAM,CAAC,SAAS,EAAE,CAAC;YACnB,IAAI,CAAC,aAAa,CAAC,GAAG,EAAE,MAAM,CAAC,OAAO,EAAE,CAAC,CAAC,EAAE,CAAC,IAAA,0BAAS,EAAC,IAAI,CAAC,mBAAmB,CAAC,CAAC,CAAC,EAAE,MAAM,CAAC,SAAS,CAAC,CAAC,CAAC;QAC3G,CAAC;aAAM,CAAC;YACJ,IAAI,CAAC,aAAa,CAAC,GAAG,EAAE,MAAM,CAAC,OAAO,CAAC,CAAC;QAC5C,CAAC;QAED,IAAI,MAAM,CAAC,KAAK,EAAE,CAAC;YACf,IAAI,CAAC,UAAU,CAAC,GAAG,EAAE,MAAM,CAAC,KAAK,CAAC,QAAQ,EAAE,MAAM,CAAC,KAAK,CAAC,SAAS,CAAC,CAAC;QACxE,CAAC;IACL,CAAC;IAES,MAAM,CAAC,GAAe;QAC5B,IAAI,OAAO,GAAG,KAAK,QAAQ,EAAE,CAAC;YAC1B,OAAO,GAAG,CAAC;QACf,CAAC;QACD,OAAO,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,CAAC;IAC/B,CAAC;IAED,iBAAiB;IACP,MAAM,CAAC,mBAAmB,CAAC,MAA2B;QAC5D,OAAO,gBAAc,CAAC,QAAQ,CAAC,mBAAmB,CAAC,MAAM,CAAC,CAAC;IAC/D,CAAC;IAES,mBAAmB,CAAC,MAA2B;QACrD,MAAM,QAAQ,GAAG,eAAK,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC;QACtC,QAAQ,CAAC,QAAQ,CAAC,OAAO,CAAC,YAAY,CAAC,GAAG,UAAU,CAAC;QACrD,QAAQ,CAAC,QAAQ,CAAC,OAAO,CAAC,cAAc,CAAC,GAAG,kBAAkB,CAAC;QAC/D,QAAQ,CAAC,QAAQ,CAAC,OAAO,CAAC,QAAQ,CAAC,GAAG,kBAAkB,CAAC;QACzD,QAAQ,CAAC,QAAQ,CAAC,OAAO,GAAG,OAAO,CAAC;QACpC,QAAQ,CAAC,YAAY,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC,QAAQ,EAAE,EAAE,CAAC,QAAQ,EAAE,CAAC,KAAK,EAAE,EAAE;;YACjE,MAAM,KAAK,GAAG,CAAA,MAAA,KAAK,CAAC,QAAQ,0CAAE,MAAM,MAAK,GAAG,CAAC;YAC7C,MAAM,CAAC,gBAAgB,CAAC,KAAK,EAAE;gBAC3B,KAAK,EAAE,KAAK,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,OAAO;gBAChC,KAAK,EAAE;oBACH,YAAY,EAAE,MAAA,KAAK,CAAC,QAAQ,0CAAE,MAAM;oBACpC,QAAQ,EAAE,MAAA,KAAK,CAAC,MAAM,0CAAE,GAAG;iBAC9B;aACJ,CAAC,CAAC;YACH,CAAC,IAAI,CAAC,MAAM,IAAI,OAAO,CAAC,CAAC,KAAK,CAAC,8BAA+B,MAAA,KAAK,CAAC,QAAQ,0CAAE,MAAO,IAAK,KAAK,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,EAAG,EAAE,CAAC,CAAC;YACnH,CAAC,IAAI,CAAC,MAAM,IAAI,OAAO,CAAC,CAAC,KAAK,CAAC,MAAA,KAAK,CAAC,MAAM,0CAAE,GAAG,CAAC,CAAC;YAClD,CAAC,IAAI,CAAC,MAAM,IAAI,OAAO,CAAC,CAAC,KAAK,CAAC,IAAI,CAAC,SAAS,CAAC,CAAA,MAAA,KAAK,CAAC,QAAQ,0CAAE,IAAI,KAAI,KAAK,CAAC,QAAQ,EAAE,IAAI,EAAE,CAAC,CAAC,CAAC,CAAC;YAChG,CAAC,IAAI,CAAC,MAAM,IAAI,OAAO,CAAC,CAAC,KAAK,CAAC,IAAI,CAAC,SAAS,CAAC,MAAA,KAAK,CAAC,QAAQ,0CAAE,OAAO,EAAE,IAAI,EAAE,CAAC,CAAC,CAAC,CAAC;YACjF,CAAC,IAAI,CAAC,MAAM,IAAI,OAAO,CAAC,CAAC,KAAK,CAAC,IAAI,CAAC,SAAS,CAAC,MAAA,KAAK,CAAC,OAAO,0CAAE,IAAI,EAAE,IAAI,EAAE,CAAC,CAAC,CAAC,CAAC;YAC7E,MAAM,KAAK,CAAC;QAChB,CAAC,CAAC,CAAC;QACH,OAAO,QAAQ,CAAC;IACpB,CAAC;IAED,iBAAiB;IACP,MAAM,CAAC,aAAa,CAAC,GAAW,EAAE,MAA0B,EAAE,SAA2B,CAAC,CAAC,EAAE,EAAE,CAAC,gBAAc,CAAC,mBAAmB,CAAC,CAAC,CAAC;QAC3I,OAAO,gBAAc,CAAC,QAAQ,CAAC,aAAa,CAAC,GAAG,EAAE,MAAM,EAAE,MAAM,CAAC,CAAC;IACtE,CAAC;IAES,aAAa,CAAC,GAAW,EAAE,MAA0B,EAAE,SAA2B,CAAC,CAAC,EAAE,EAAE,CAAC,IAAI,CAAC,mBAAmB,CAAC,CAAC,CAAC;QAC1H,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,GAAG,EAAE,MAAM,CAAC,MAAM,CAAC,CAAC,CAAC;QACxC,CAAC,IAAI,CAAC,MAAM,IAAI,OAAO,CAAC,CAAC,IAAI,CAAC,wBAAwB,GAAG,GAAG,CAAC,CAAC;IAClE,CAAC;IAED,iBAAiB;IACP,MAAM,CAAC,UAAU,CAAC,GAAW,EAAE,QAAgB,EAAE,SAAiB;QACxE,OAAO,gBAAc,CAAC,QAAQ,CAAC,UAAU,CAAC,GAAG,EAAE,QAAQ,EAAE,SAAS,CAAC,CAAC;IACxE,CAAC;IAES,UAAU,CAAC,GAAW,EAAE,QAAgB,EAAE,SAAiB;QACjE,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,GAAG,EAAE,IAAI,gBAAQ,CAAoC,OAAO,CAAC,EAAE;YAC3E,OAAO,IAAI,CAAC,eAAe,CAAC,OAAO,EAAE,GAAG,CAAC,CAAC;QAC9C,CAAC,EAAE,QAAQ,EAAE,SAAS,CAAC,CAAC,CAAC;QACzB,CAAC,IAAI,CAAC,MAAM,IAAI,OAAO,CAAC,CAAC,IAAI,CAAC,uBAAuB,GAAG,GAAG,CAAC,CAAC;IACjE,CAAC;IAED,iBAAiB;IACP,MAAM,CAAC,KAAK,CAAC,eAAe,CAAC,OAA2B,EAAE,OAA+B,gBAAc,CAAC,aAAa;QAC3H,OAAO,gBAAc,CAAC,QAAQ,CAAC,eAAe,CAAC,OAAO,EAAE,IAAI,CAAC,CAAC;IAClE,CAAC;IAES,KAAK,CAAC,eAAe,CAAC,OAA2B,EAAE,OAA+B,IAAI,CAAC,eAAe;;QAC5G,IAAI,QAAuB,CAAC;QAC5B,IAAI,WAAW,GAAW,SAAS,CAAC;QACpC,IAAI,OAAO,IAAI,KAAK,QAAQ,EAAE,CAAC;YAC3B,QAAQ,GAAG,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;YACpC,WAAW,GAAG,IAAI,CAAC;QACvB,CAAC;aAAM,CAAC;YACJ,QAAQ,GAAG,IAAqB,CAAC;QACrC,CAAC;QAED,IAAI,CAAC,QAAQ,EAAE,CAAC;YACZ,MAAM,IAAI,KAAK,CAAC,4BAA4B,GAAG,IAAI,CAAC,CAAC;QACzD,CAAC;QAED,MAAM,KAAK,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;QAEzB,IAAI,UAAU,GAAG,CAAA,MAAA,OAAO,CAAC,OAAO,0CAAG,uBAAuB,CAAC,KAAI,UAAU,CAAC;QAC1E,CAAC,IAAI,CAAC,MAAM,IAAI,OAAO,CAAC,CAAC,KAAK,CAAC,GAAI,UAAW,QAAS,OAAO,CAAC,MAAM,IAAI,KAAM,IAAK,OAAO,CAAC,GAAI,QAAS,WAAY,EAAE,CAAC,CAAC;QAEzH,MAAM,QAAQ,GAAG,MAAM,QAAQ,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC;QACjD,MAAM,GAAG,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;QAEvB,CAAC,IAAI,CAAC,MAAM,IAAI,OAAO,CAAC,CAAC,KAAK,CAAC,GAAI,UAAW,QAAS,OAAO,CAAC,MAAM,IAAI,KAAM,IAAK,OAAO,CAAC,GAAI,KAAM,QAAQ,CAAC,MAAO,QAAS,GAAG,GAAG,KAAM,IAAI,CAAC,CAAC;QAEjJ,OAAO,QAAQ,CAAC;IACpB,CAAC;IAED,iBAAiB;IACV,MAAM,CAAC,KAAK,CAAC,cAAc,CAAuB,GAAM,EAAE,OAA2B,EAAE,UAAuB;QACjH,OAAO,gBAAc,CAAC,QAAQ,CAAC,cAAc,CAAC,GAAG,EAAE,OAAO,EAAE,UAAU,CAAC,CAAC;IAC5E,CAAC;IAEM,KAAK,CAAC,cAAc,CAAuB,GAAM,EAAE,OAA2B,EAAE,UAAuB;QAC1G,MAAM,CAAC,GAAG,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;QAC3B,MAAM,CAAC,GAAG,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;QAE7B,IAAI,UAAU,EAAE,CAAC;YACb,OAAO,CAAC,OAAO,GAAG,OAAO,CAAC,OAAO,IAAI,EAAE,CAAC;YACxC,OAAO,CAAC,OAAO,CAAC,uBAAuB,CAAC,GAAG,UAAU,CAAC;QAC1D,CAAC;QAED,IAAI,CAAC,CAAC,EAAE,CAAC;YACL,OAAO,IAAI,CAAC,eAAe,CAAC,OAAO,EAAE,CAAC,CAAC,CAAC;YACxC,iDAAiD;QACrD,CAAC;QAED,IAAI,CAAC,CAAC,IAAI,GAAG,cAAc,EAAE,CAAC;YAC1B,CAAC,IAAI,CAAC,MAAM,IAAI,OAAO,CAAC,CAAC,IAAI,CAAC,GAAI,UAAW,uCAAwC,CAAE,aAAc,CAAC,CAAC,IAAK,KAAK,CAAC,CAAC;YACnH,MAAM,IAAI,KAAK,CAAC,wBAAwB,CAAC,CAAC;QAC9C,CAAC;QAED,CAAC,IAAI,CAAC,MAAM,IAAI,OAAO,CAAC,CAAC,KAAK,CAAC,GAAI,UAAW,QAAS,OAAO,CAAC,MAAM,IAAI,KAAM,IAAK,OAAO,CAAC,GAAI,EAAE,CAAC,CAAC;QAEpG,OAAO,MAAM,CAAC,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;IAChC,CAAC;;AAtOQ,wCAAc;AAET,kBAAG,GAAgB,IAAI,GAAG,EAAU,AAAjC,CAAkC;AAIzB,+BAAgB,GAAqB;IAC3D,WAAW,EAAE,GAAG;IAChB,eAAe,EAAE,EAAE,GAAG,EAAE,GAAG,IAAI;CAClC,AAHyC,CAGzC;yBATQ,cAAc;IAD1B,IAAA,sBAAU,GAAE;IAuCJ,WAAA,IAAA,kBAAM,EAAC,YAAS,CAAC,WAAW,CAAC,CAAA;IAC7B,WAAA,IAAA,kBAAM,EAAC,YAAS,CAAC,eAAe,CAAC,CAAA;;GAvC7B,cAAc,CAwO1B","sourcesContent":["import axios, { AxiosInstance, AxiosRequestConfig, AxiosResponse, CreateAxiosDefaults } from \"axios\";\r\nimport { JobQueue } from \"jobqu\";\r\nimport rateLimit, { rateLimitOptions } from \"axios-rate-limit\";\r\nimport { Time } from \"@inventivetalent/time\";\r\nimport { RequestConfig, RequestKey } from \"./RequestConfig\";\r\nimport { networkInterfaces } from \"os\";\r\nimport * as https from \"node:https\";\r\nimport { HttpsProxyAgent } from \"https-proxy-agent\";\r\nimport { Breadcrumb } from \"@mineskin/types\";\r\nimport { isPublicNetworkInterface } from \"./util\";\r\nimport * as Sentry from \"@sentry/node\";\r\nimport { IRequestExecutor } from \"@mineskin/core\";\r\nimport { inject, injectable } from \"inversify\";\r\nimport { ICredentialService, ILogProvider, IMetricsProvider, TYPES as CoreTypes } from \"@mineskin/core\";\r\nimport winston from \"winston\";\r\n\r\nexport const GENERIC = \"generic\";\r\n\r\nconst MAX_QUEUE_SIZE = 100;\r\nconst TIMEOUT = 10000;\r\n\r\n@injectable()\r\nexport class RequestManager implements IRequestExecutor {\r\n\r\n    public static IPS: Set<string> = new Set<string>();\r\n\r\n    readonly defaultInstance: AxiosInstance = this.createAxiosInstance({});\r\n\r\n    protected static readonly defaultRateLimit: rateLimitOptions = {\r\n        maxRequests: 600,\r\n        perMilliseconds: 10 * 60 * 1000\r\n    }\r\n\r\n    protected readonly instances: Map<string, AxiosInstance> = new Map<string, AxiosInstance>();\r\n    protected readonly queues: Map<string, JobQueue<AxiosRequestConfig, AxiosResponse>> = new Map<string, JobQueue<AxiosRequestConfig, AxiosResponse>>();\r\n\r\n    private static _instance: RequestManager;\r\n\r\n    readonly logger: winston.Logger;\r\n\r\n    /**@deprecated**/\r\n    static get instance(): RequestManager {\r\n        if (!this._instance) {\r\n            console.trace(\"Creating new RequestManager instance\");\r\n            this._instance = new RequestManager(undefined, undefined);\r\n        }\r\n        return this._instance;\r\n    }\r\n\r\n    /**@deprecated**/\r\n    static init() {\r\n        RequestManager.instance;\r\n    }\r\n\r\n    /**@deprecated**/\r\n    static get axiosInstance(): AxiosInstance {\r\n        return RequestManager.instance.defaultInstance;\r\n    }\r\n\r\n    constructor(\r\n        @inject(CoreTypes.LogProvider) readonly logProvider: ILogProvider | undefined,\r\n        @inject(CoreTypes.MetricsProvider) readonly metrics: IMetricsProvider | undefined,\r\n    ) {\r\n        if (!logProvider) {\r\n            console.warn(\"No log provider injected!\");\r\n        } else {\r\n            this.logger = logProvider.l.child({label: \"Requests\"});\r\n        }\r\n        if (!metrics) {\r\n            console.warn(\"No metrics provider injected!\");\r\n        }\r\n\r\n        const interfaces = networkInterfaces();\r\n        i: for (let id in interfaces) {\r\n            const iface = interfaces[id];\r\n            a: for (let address of iface) {\r\n                if (!isPublicNetworkInterface(address)) {\r\n                    continue i; // skip interface\r\n                }\r\n\r\n                (this.logger || console).info(`${ address.family } ${ address.address } ${ address.netmask } ${ address.mac } ${ address.cidr }`);\r\n                RequestManager.IPS.add(address.address);\r\n            }\r\n        }\r\n\r\n        this.setupInstance(GENERIC, {});\r\n        this.setupQueue(GENERIC, Time.millis(100), 1);\r\n    }\r\n\r\n    /**@deprecated**/\r\n    static registerInstance<K extends RequestKey>(config: RequestConfig<K>) {\r\n        return RequestManager.instance.registerInstance(config);\r\n    }\r\n\r\n    registerInstance<K extends RequestKey>(config: RequestConfig<K>) {\r\n        const key = this.mapKey(config.key);\r\n        if (this.instances.has(key)) {\r\n            (this.logger || console).warn(`Instance with key ${ key } already exists!`);\r\n            return;\r\n        }\r\n        if (this.queues.has(key)) {\r\n            (this.logger || console).warn(`Queue with key ${ key } already exists!`);\r\n            return;\r\n        }\r\n\r\n        if (config?.ip?.bind) {\r\n            const bind = config.ip.bind;\r\n            if (!RequestManager.IPS.has(bind)) {\r\n                console.warn(`IP ${ bind } not found on this machine`);\r\n            } else {\r\n                console.info(`Binding ${ key } to IP ${ bind }`);\r\n                config.request.httpsAgent = new https.Agent({\r\n                    localAddress: config.ip.bind,\r\n                    family: config.ip.bind.includes(\":\") ? 6 : 4\r\n                });\r\n            }\r\n        }\r\n\r\n        if (config.proxy) {\r\n            (this.logger || console).info(`Setting up proxy for ${ key } via ${ config.proxy.host }`);\r\n            config.request.httpsAgent = new HttpsProxyAgent(config.proxy)\r\n        }\r\n\r\n        if (config.rateLimit) {\r\n            this.setupInstance(key, config.request, c => rateLimit(this.createAxiosInstance(c), config.rateLimit));\r\n        } else {\r\n            this.setupInstance(key, config.request);\r\n        }\r\n\r\n        if (config.queue) {\r\n            this.setupQueue(key, config.queue.interval, config.queue.maxPerRun);\r\n        }\r\n    }\r\n\r\n    protected mapKey(key: RequestKey): string {\r\n        if (typeof key === \"string\") {\r\n            return key;\r\n        }\r\n        return JSON.stringify(key);\r\n    }\r\n\r\n    /**@deprecated**/\r\n    protected static createAxiosInstance(config: CreateAxiosDefaults) {\r\n        return RequestManager.instance.createAxiosInstance(config);\r\n    }\r\n\r\n    protected createAxiosInstance(config: CreateAxiosDefaults): AxiosInstance {\r\n        const instance = axios.create(config);\r\n        instance.defaults.headers[\"User-Agent\"] = \"MineSkin\";\r\n        instance.defaults.headers[\"Content-Type\"] = \"application/json\";\r\n        instance.defaults.headers[\"Accept\"] = \"application/json\";\r\n        instance.defaults.timeout = TIMEOUT;\r\n        instance.interceptors.response.use((response) => response, (error) => {\r\n            const is429 = error.response?.status === 429;\r\n            Sentry.captureException(error, {\r\n                level: is429 ? 'fatal' : 'error',\r\n                extra: {\r\n                    responseCode: error.response?.status,\r\n                    endpoint: error.config?.url\r\n                }\r\n            });\r\n            (this.logger || console).error(`Error in Axios API, status ${ error.response?.status } ${ is429 ? \"(429)\" : \"\" }`);\r\n            (this.logger || console).error(error.config?.url);\r\n            (this.logger || console).error(JSON.stringify(error.response?.data || error.response, null, 2));\r\n            (this.logger || console).error(JSON.stringify(error.response?.headers, null, 2));\r\n            (this.logger || console).error(JSON.stringify(error.request?.data, null, 2));\r\n            throw error;\r\n        });\r\n        return instance;\r\n    }\r\n\r\n    /**@deprecated**/\r\n    protected static setupInstance(key: string, config: AxiosRequestConfig, constr: AxiosConstructor = (c) => RequestManager.createAxiosInstance(c)) {\r\n        return RequestManager.instance.setupInstance(key, config, constr);\r\n    }\r\n\r\n    protected setupInstance(key: string, config: AxiosRequestConfig, constr: AxiosConstructor = (c) => this.createAxiosInstance(c)) {\r\n        this.instances.set(key, constr(config));\r\n        (this.logger || console).info(\"set up axios instance \" + key);\r\n    }\r\n\r\n    /**@deprecated**/\r\n    protected static setupQueue(key: string, interval: number, maxPerRun: number): void {\r\n        return RequestManager.instance.setupQueue(key, interval, maxPerRun);\r\n    }\r\n\r\n    protected setupQueue(key: string, interval: number, maxPerRun: number): void {\r\n        this.queues.set(key, new JobQueue<AxiosRequestConfig, AxiosResponse>(request => {\r\n            return this.runAxiosRequest(request, key);\r\n        }, interval, maxPerRun));\r\n        (this.logger || console).info(\"set up request queue \" + key);\r\n    }\r\n\r\n    /**@deprecated**/\r\n    protected static async runAxiosRequest(request: AxiosRequestConfig, inst: AxiosInstance | string = RequestManager.axiosInstance): Promise<AxiosResponse> {\r\n        return RequestManager.instance.runAxiosRequest(request, inst);\r\n    }\r\n\r\n    protected async runAxiosRequest(request: AxiosRequestConfig, inst: AxiosInstance | string = this.defaultInstance): Promise<AxiosResponse> {\r\n        let instance: AxiosInstance;\r\n        let instanceKey: string = \"default\";\r\n        if (typeof inst === \"string\") {\r\n            instance = this.instances.get(inst);\r\n            instanceKey = inst;\r\n        } else {\r\n            instance = inst as AxiosInstance;\r\n        }\r\n\r\n        if (!instance) {\r\n            throw new Error(\"No instance found for key \" + inst);\r\n        }\r\n\r\n        const start = Date.now();\r\n\r\n        let breadcrumb = request.headers?.[\"X-MineSkin-Breadcrumb\"] || \"00000000\";\r\n        (this.logger || console).debug(`${ breadcrumb } ==> ${ request.method || 'GET' } ${ request.url } via ${ instanceKey }`);\r\n\r\n        const response = await instance.request(request);\r\n        const end = Date.now();\r\n\r\n        (this.logger || console).debug(`${ breadcrumb } <== ${ request.method || 'GET' } ${ request.url } (${ response.status }) in ${ end - start }ms`);\r\n\r\n        return response;\r\n    }\r\n\r\n    /**@deprecated**/\r\n    public static async dynamicRequest<K extends RequestKey>(key: K, request: AxiosRequestConfig, breadcrumb?: Breadcrumb): Promise<AxiosResponse> {\r\n        return RequestManager.instance.dynamicRequest(key, request, breadcrumb);\r\n    }\r\n\r\n    public async dynamicRequest<K extends RequestKey>(key: K, request: AxiosRequestConfig, breadcrumb?: Breadcrumb): Promise<AxiosResponse> {\r\n        const k = this.mapKey(key);\r\n        const q = this.queues.get(k);\r\n\r\n        if (breadcrumb) {\r\n            request.headers = request.headers || {};\r\n            request.headers[\"X-MineSkin-Breadcrumb\"] = breadcrumb;\r\n        }\r\n\r\n        if (!q) {\r\n            return this.runAxiosRequest(request, k);\r\n            //throw new Error(\"No queue found for key \" + k);\r\n        }\r\n\r\n        if (q.size > MAX_QUEUE_SIZE) {\r\n            (this.logger || console).warn(`${ breadcrumb } Rejecting new request as queue for ${ k } is full (${ q.size })! `);\r\n            throw new Error(\"Request queue is full!\");\r\n        }\r\n\r\n        (this.logger || console).debug(`${ breadcrumb } ... ${ request.method || 'GET' } ${ request.url }`);\r\n\r\n        return await q.add(request);\r\n    }\r\n\r\n}\r\n\r\ntype AxiosConstructor = (config: AxiosRequestConfig) => AxiosInstance;\r\n"]}